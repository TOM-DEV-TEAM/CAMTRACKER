{% extends 'layouts/base.html' %}
{% load static %}
<style>
    .btn-outline-primary.custom-checked {
        background-color: #00FFFF; /* Bleu clair */
        color: white; /* Texte blanc pour contraste */
        border-color: #00ffff;
    }

    .btn-outline-primary {
        border-color:#00FFFF; /* Bordure bleu clair */
        color: #00FFFF; /* Texte bleu clair */
    }
</style>
<script>
    // Ajout d'un événement pour modifier l'apparence des boutons sélectionnés
    const radios = document.querySelectorAll('input[name="zone"]');
    radios.forEach(radio => {
        radio.addEventListener('change', function () {
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('custom-checked'));
            document.querySelector(`label[for="${this.id}"]`).classList.add('custom-checked');
        });
    });
</script>
{% block breadcrumbs %}{% endblock breadcrumbs %}

{% block content %}
 <ul class="nav nav-tabs" style="margin-left: 20px">

  <li class="nav-item">
    <a class="nav-link " href="/sortie_decalog_view/{{ util.id_user }}">ICD TOM</a>
  </li>  <li class="nav-item">
    <a class="nav-link " href="/sortie_decalog_view01/{{ util.id_user }}">ICD CMA</a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="/sortie_decalog_view1/{{ util.id_user }}" tabindex="-1" >SACHERIE</a>
  </li> <li class="nav-item">
    <a class="nav-link " href="/sortie_decalog_view2/{{ util.id_user }}" tabindex="-1" >ZUD</a>
  </li>     <li class="nav-item">
    <a class="nav-link" href="/sortie_decalog_viewparticulier/{{ util.id_user }}" tabindex="-1" >PARTICULIER</a>
  </li>
</ul><br>

    <!-- [ rating list ] end-->
    <div class="col-xl-8 col-md-12 m-b-30">


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Fonction pour obtenir la valeur du cookie CSRF
    function getCookie(name) {
        let cookieValue = null;

        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Fonction pour déterminer si la méthode de requête est sûre pour CSRF
    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    // Configuration globale des requêtes AJAX pour inclure le jeton CSRF
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    // Fonction pour récupérer et afficher les mouvements depuis l'API Django
    $(document).ready(function() {
        function fetchMouvements() {
            let paragraph = document.getElementById('p1');

// Récupérer le texte du paragraphe
let textContent = paragraph.textContent;
            $.ajax({
                url: "{% url 'liste_mouvementsdk11' id_user=util.id_user %}",  // URL de l'API Django pour récupérer les mouvements
                method: "GET",
                success: function(data) {
                    var tableBody = $('#mouvements-table tbody');
                    tableBody.empty();
                    data.mouvements.forEach(function(mouvement_list) {

                        var camionvoyage = mouvement_list.camion.immatriculation ? mouvement_list.camion.immatriculation : 'vide';
                        var statutText = '';
                        if (mouvement_list.statut_sortie === 0) {
                            statutText = 'DECHARGE';
                        } else if (mouvement_list.statut_sortie === 1) {
                            statutText = 'CHARGE';
                        }else {
                            statutText='NON ASSIGNE'
                        }

                        var row = `<tr>


                           <!--<td>${statutText}</td>-->
                             <td>${camionvoyage}</td>
                            <td style="text-transform: uppercase">${mouvement_list.destination}</td>
                            <td>${mouvement_list.camion.transporteur}</td>
                            <td>${mouvement_list.remorque}</td>
                            <td>${mouvement_list.chauffeur.fullname}</td>
                            <td>${mouvement_list.chauffeur.permis}</td>
                            <td>
                            <a class="label theme-bg text-white f-12"  class="btn btn-info btn-lg"
                                       data-id="${mouvement_list.id_mvt}"
                                       data-immat ="${camionvoyage}"
                                       data-utilisateur-id="${textContent}"
                                       href="#!"
                                       data-toggle="modal"
                                       data-target="#editModal">
                                       SORTIE
                                    </a>
                            </td>
                        </tr>`;

                        tableBody.append(row);
                    });

                    // Ré-attacher le gestionnaire de clic pour le bouton "SORTIE"
                    tableBody.off('click', '.sortie-dp-btn').on('click', '.sortie-dp-btn', function() {
                        var idMvt = $(this).data('id');
                        var utilisateurId = $(this).data('utilisateur-id');
                        // Redirection vers la page d'ajout de fin de mouvement après avoir cliqué sur "SORTIE"
                        window.location.href = `/ajoutsortie/${idMvt}/${utilisateurId}`;
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Erreur de récupération des mouvements:', error);
                }
            });
        }

        fetchMouvements();
        setInterval(fetchMouvements, 1000);
    });
</script>


        <h3 class="modal-title" id="editModalLabel">Sortie Camions SACHERIE</h3>

        <div class="container  ">
        <div class="table-responsive">
         <table id="mouvements-table" class="table table-striped table-hover">
                    <thead class="thead-light">
                        <tr>
                            
                            <th scope="col">Camion</th>
                            <th scope="col">Destination</th>
                            <th scope="col">Transporteur </th>
                            <th scope="col">Remorque </th>
                            <th scope="col">Chauffeur</th>
                             <th scope="col">Permis </th>
                            <th scope="col" class="col-1">Action</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
           </table>
        </div>
        </div>






</div>
    <div class="container">
  <!--<h2>Modal Example</h2>
   Trigger the modal with a button
  <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button>

   Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Sortie Camion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm" method="post" action="{% url 'ajoutsortiedk' %}">
                    {% csrf_token %}
                    {{ form.non_field_errors }}
                     <div class="form-group">
                <label for="bd" class="form-label">Zone</label><br>
                <div class="form-check form-check-inline">
                    <input value="Sud" type="radio" name="zone"  checked required class="form-check-input">
                    <label for="bdOui" class="form-check-label">Sud</label>
                </div>
                <div class="form-check form-check-inline">
                    <input value="Nord" type="radio" name="zone"  required class="form-check-input">
                    <label for="bdNon" class="form-check-label">Nord</label>
                </div>
            </div>
                     <input TYPE="hidden" name="source" value="sacherie">
                    <!-- Champ caché pour ID Mouvement -->
                    <input type="hidden" id="idMvt" name="id_mvt">

                    <!-- Champ caché pour ID Utilisateur -->
                    <input type="hidden" id="utilisateurId" name="id_user">

                    <div class="form-group mb-4">
                        <label for="statut_sortie">Camion</label>
                        <input  id="immat" class="form-control form-control-lg" readonly/>
                    </div>
                    <div class="form-groupe">
                        <label class="">Code Du Camion</label>
                        <input  name="code_camion" placeholder="Code Du Véhicule" class="form-control form-control-lg" required/>
                    </div>
        <div class="row">
            <!-- Champ Point du Camion -->
            <div class="col-md-6">
                <div class="form-group">
                    <label for="pointCamion">Poids du Camion</label>
                    <input type="number" id="pontCamion" name="pont_camion" class="form-control" placeholder="Poids du Camion" step="any" min="0">
                </div>
            </div>
            <!-- Champ Point Autorisé -->
            <div class="col-md-6">
                <div class="form-group">
                    <label for="pointAutorise">Poids Autorisé</label>
                    <input type="number" id="pointAutorise" name="poids_autorise" class="form-control" placeholder="Poids Autorisé" step="any" min="0">
                </div>
            </div>
        </div>
        <div class="row">
    <!-- Sélection du Pays -->
    <div class="col-md-6">
        <div class="form-group">
            <label for="pays">Pays</label>
            <select id="pays" name="pays" class="form-control" onchange="updateDestinations()">
                <option value="">Sélectionner un pays</option>
                <option value="senegal">Sénégal</option>
                <option value="mali">Mali</option>
                <option value="guineeBisseau">Guinée-Bissau</option>
                <option value="gambie">Gambie</option>
            </select>
        </div>
    </div>
    <!-- Sélection de la Destination -->
    <div class="col-md-6">
        <div class="form-group">
            <label for="destination">Destination</label>
            <select id="destination" name="destination" class="form-control">
            </select>
        </div>
    </div>
</div>

    <!-- Sélection de la Destination -->

            <!-- Remorque, Destination, et Destination par Pays -->
        <div class="row align-items-center">
            <!-- Pont Bascule -->
            <div class="col-md-6">
                <div class="form-group">
                    <label for="enPanne" class="form-label">Pont Bascule</label><br>
                    <div class="form-check form-check-inline">
                        <input value="1" type="radio" name="pont_bascule" id="ddOui" checked required class="form-check-input">
                        <label for="ddOui" class="form-check-label">Oui</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input value="0" type="radio" name="pont_bascule" id="ddNon" required class="form-check-input">
                        <label for="ddNon" class="form-check-label">Non</label>
                    </div>
                </div>
            </div>

            <!-- Remorque -->
            <div class="col-md-6">
                <div class="form-group">
                    <label for="remorque">Remorque</label>
                    <input type="text" id="remorque" name="remorque" class="form-control" placeholder="Remorque">
                </div>
            </div>
        </div>



                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



    </div>
  </div>


    </div>



    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');

        if (success === 'true') {
            Swal.fire({
                icon: 'success',
                title: 'Effectué',
                text: 'L\'ajout a été effectué avec succès.',
                showConfirmButton: false,  // Ne pas afficher le bouton OK
                timer: 1000  // Afficher le message pendant 3 secondes
            });
        } else if (error) {
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: error,
                confirmButtonText: 'OK'
            });
        }
    });
    </script>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Modal Bootstrap -->

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // Fonction pour mettre à jour les destinations en fonction du pays sélectionné
        function updateDestinations() {
            var pays = document.getElementById('pays').value;
            var destination = document.getElementById('destination');

            // Vider les options existantes
            destination.innerHTML = '';

            var options = [];
            switch (pays) {
                case 'senegal':
                      options = [
                        'Dakar', 'Thiès', 'Saint-Louis', 'Ziguinchor', 'Kaolack', 'Kolda', 'Tambacounda', 'Louga',
                        'Fatick', 'Sédhiou', 'Matam', 'Kédougou', 'Birkilane', 'Goudiry'
                    ];
                    break;
                case 'mali':
                    options = ['Bamako', 'Kidiria', 'Moussala', 'Kayes'];
                    break;
                case 'guineeBisseau':
                    options = ['Guinée-Bissau'];
                    break;
                case 'gambie':
                    options = ['Gambie'];
                    break;
                default:
                    options = [];
                    break;
            }

            // Ajouter les options au menu déroulant
            options.forEach(function(option) {
                var opt = document.createElement('option');
                opt.value = option.toLowerCase().replace(/ /g, '_');
                opt.innerHTML = option;
                destination.appendChild(opt);
            });
        }
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');

        if (success === 'true') {
            Swal.fire({
                icon: 'success',
                title: 'Effectué',
                text: 'L\'ajout a été effectué avec succès.',
                showConfirmButton: false,  // Ne pas afficher le bouton OK
                timer: 1000  // Afficher le message pendant 3 secondes
            });
        } else if (error) {
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: error,
                confirmButtonText: 'OK'
            });
        }
    });
    </script>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Inclure les scripts de Bootstrap et jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    $('#editModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Bouton qui a déclenché le modal
        var idMvt = button.data('id'); // Extraire les informations des attributs data-*
        var utilisateurId = button.data('utilisateur-id');
        var iMMat = button.data('immat');

        var modal = $(this);
        modal.find('#idMvt').val(idMvt);
        modal.find('#immat').attr('placeholder', iMMat);

        modal.find('#utilisateurId').val(utilisateurId);
    });
</script>
<p  id="p1" STYLE="color: white">   {{ util.id_user }}</p>

    </div>
  </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

{% endblock content %}
